/**
 * Angular feedback directive similar to Google Feedback
 * @version v1.0.2 - 2016-04-11 * @link https://github.com/jacobscarter/angular-feedback
 * @author Jacob Carter <jacob@ieksolutions.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("templates-angularsendfeedback",["angularsendfeedback.html"]),angular.module("angularsendfeedback.html",[]).run(["$templateCache",function(a){a.put("angularsendfeedback.html","")}]),angular.module("angular-send-feedback",["templates-angularsendfeedback"]),angular.module("angular-send-feedback").directive("angularFeedback",["$http",function(a){return{restrict:"EA",replace:!0,transclude:!0,scope:{options:"="},link:function(b,c,d){!function(b){b.feedback=function(c){function d(a){var c=b("<p>").text(a);b("#feedback-additional-info").append(b("<li>").append(c))}function e(){canDraw=!1,b(document).off("mouseenter mouseleave",".feedback-helper"),b(document).off("mouseup keyup"),b(document).off("mousedown",".feedback-setblackout"),b(document).off("mousedown",".feedback-sethighlight"),b(document).off("mousedown click","#feedback-close"),b(document).off("mousedown","#feedback-canvas"),b(document).off("click","#feedback-highlighter-next"),b(document).off("click","#feedback-highlighter-back"),b(document).off("click","#feedback-welcome-next"),b(document).off("click","#feedback-overview-back"),b(document).off("mouseleave","body"),b(document).off("mouseenter",".feedback-helper"),b(document).off("selectstart dragstart",document),b("#feedback-module").off("click",".feedback-wizard-close,.feedback-close-btn"),b(document).off("click","#feedback-submit"),h.highlightElement&&(b(document).off("click","#feedback-canvas"),b(document).off("mousemove","#feedback-canvas")),b('[data-highlighted="true"]').removeAttr("data-highlight-id").removeAttr("data-highlighted"),b("#feedback-module").remove(),b(".feedback-btn").show(),h.onClose.call(this)}function f(a,c){c="undefined"!=typeof c?c:!0,a.clearRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),a.fillStyle="rgba(102,102,102,0.5)",a.fillRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&c&&g(a,parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&a.clearRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),b(".feedback-helper").each(function(){"blackout"==b(this).attr("data-type")&&(a.fillStyle="rgba(0,0,0,1)",a.fillRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height()))})}function g(a,b,c,d,e){a.strokeStyle=h.strokeStyle,a.shadowColor=h.shadowColor,a.shadowOffsetX=h.shadowOffsetX,a.shadowOffsetY=h.shadowOffsetY,a.shadowBlur=h.shadowBlur,a.lineJoin=h.lineJoin,a.lineWidth=h.lineWidth,a.strokeRect(b,c,d,e),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.lineWidth=1}var h=b.extend({ajaxURL:"",postBrowserInfo:!0,postHTML:!0,postURL:!0,proxy:void 0,letterRendering:!1,initButtonText:"Send feedback",html2canvas:function(){},strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:10,lineJoin:"bevel",lineWidth:3,feedbackButton:".feedback-btn",showDescriptionModal:!0,isDraggable:!0,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div class="ico"></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Description</h3><p id="feedback-info">We will also send the following information:</p><ul id="feedback-additional-info"></ul></div></div><div id="feedback-overview-screenshot"><h3>Screenshot</h3></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p><p>We cannot respond individually to every one, but we will use your comments as we strive to improve your experience.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:!0,highlightElement:!0,initialBox:!1},c),i=!!window.HTMLCanvasElement,j=".feedback-btn"==h.feedbackButton,k=h.html2canvas;i&&(j&&b("body").append('<button class="feedback-btn feedback-btn-gray">'+h.initButtonText+"</button>"),b(document).on("click",h.feedbackButton,function(){j&&b(this).hide();var c=!1,i="",l=b(document).height(),m=b(document).width(),n='<div id="feedback-module">';h.initialBox&&(n+=h.tpl.description),n+=h.tpl.highlighter+h.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>',b("body").append(n),moduleStyle={position:"absolute",left:"0px",top:"0px"},canvasAttr={width:m,height:l},b("#feedback-module").css(moduleStyle),b("#feedback-canvas").attr(canvasAttr).css("z-index","30000"),h.initialBox||(b("#feedback-highlighter-back").remove(),c=!0,b("#feedback-canvas").css("cursor","crosshair"),b("#feedback-helpers").show(),b("#feedback-welcome").hide(),b("#feedback-highlighter").show()),h.isDraggable&&b("#feedback-highlighter").on("mousedown",function(a){var c=b(this).addClass("feedback-draggable"),d=c.outerHeight(),e=c.outerWidth(),f=c.offset().top+d-a.pageY,g=c.offset().left+e-a.pageX;c.css("z-index",4e4).parents().on("mousemove",function(a){_top=a.pageY+f-d,_left=a.pageX+g-e,_bottom=d-a.pageY,_right=e-a.pageX,_left<0&&(_left=0),_top<0&&(_top=0),_right>b(window).width()&&(_left=b(window).width()-e),_left>b(window).width()-e&&(_left=b(window).width()-e),_bottom>b(document).height()&&(_top=b(document).height()-d),_top>b(document).height()-d&&(_top=b(document).height()-d),b(".feedback-draggable").offset({top:_top,left:_left}).on("mouseup",function(){b(this).removeClass("feedback-draggable")})}),a.preventDefault()}).on("mouseup",function(){b(this).removeClass("feedback-draggable"),b(this).parents().off("mousemove mousedown")});var o=b("#feedback-canvas")[0].getContext("2d");if(o.fillStyle="rgba(102,102,102,0.5)",o.fillRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),rect={},drag=!1,highlight=1,post={},h.postBrowserInfo&&(post.browser={},post.browser.appCodeName=navigator.appCodeName,post.browser.appName=navigator.appName,post.browser.appVersion=navigator.appVersion,post.browser.cookieEnabled=navigator.cookieEnabled,post.browser.onLine=navigator.onLine,post.browser.platform=navigator.platform,post.browser.userAgent=navigator.userAgent,post.browser.plugins=[],b.each(navigator.plugins,function(a){post.browser.plugins.push(navigator.plugins[a].name)}),d("Your browser information")),h.postURL&&(post.url=document.URL,d("The URL you are now at")),h.postHTML&&(post.html=b("html").html(),d("The contents of this page")),h.postBrowserInfo||h.postURL||h.postHTML||b("#feedback-additional-none").show(),b(document).on("mousedown","#feedback-canvas",function(a){c&&(rect.startX=a.pageX-b(this).offset().left,rect.startY=a.pageY-b(this).offset().top,rect.w=0,rect.h=0,drag=!0)}),b(document).on("mouseup",function(){if(c){drag=!1;var a=rect.startY,d=rect.startX,e=rect.w,g=rect.h;if(dtype="highlight",0==e||0==g)return;0>e&&(d+=e,e*=-1),0>g&&(a+=g,g*=-1),a+g>b(document).height()&&(g=b(document).height()-a),d+e>b(document).width()&&(e=b(document).width()-d),0==highlight&&(dtype="blackout"),b("#feedback-helpers").append('<div class="feedback-helper" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+a+"px;left:"+d+"px;width:"+e+"px;height:"+g+'px;z-index:30000;"></div>'),f(o),rect.w=0}}),b(document).on("mousemove",function(a){c&&drag&&(b("#feedback-highlighter").css("cursor","default"),rect.w=a.pageX-b("#feedback-canvas").offset().left-rect.startX,rect.h=a.pageY-b("#feedback-canvas").offset().top-rect.startY,o.clearRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),o.fillStyle="rgba(102,102,102,0.5)",o.fillRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&g(o,parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),1==highlight&&(g(o,rect.startX,rect.startY,rect.w,rect.h),o.clearRect(rect.startX,rect.startY,rect.w,rect.h)),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&o.clearRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),b(".feedback-helper").each(function(){"blackout"==b(this).attr("data-type")&&(o.fillStyle="rgba(0,0,0,1)",o.fillRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height()))}),0==highlight&&(o.fillStyle="rgba(0,0,0,0.5)",o.fillRect(rect.startX,rect.startY,rect.w,rect.h)))}),h.highlightElement){var p=[],q=[],r=0;b(document).on("mousemove click","#feedback-canvas",function(a){if(c){f(o),q=[],b("#feedback-canvas").css("cursor","crosshair"),b("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){"true"!==b(this).attr("data-highlighted")&&a.pageX>b(this).offset().left&&a.pageX<b(this).offset().left+b(this).width()&&a.pageY>b(this).offset().top+parseInt(b(this).css("padding-top"),10)&&a.pageY<b(this).offset().top+b(this).height()+parseInt(b(this).css("padding-top"),10)&&q.push(b(this))});var d=q[q.length-1];if(d&&!drag){b("#feedback-canvas").css("cursor","pointer");var e=d.offset().left-2,h=d.offset().top-2,i=d.width()+parseInt(d.css("padding-left"),10)+parseInt(d.css("padding-right"),10)+6,j=d.height()+parseInt(d.css("padding-top"),10)+parseInt(d.css("padding-bottom"),10)+6;1==highlight&&(g(o,e,h,i,j),o.clearRect(e,h,i,j),dtype="highlight"),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&o.clearRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),0==highlight&&(dtype="blackout",o.fillStyle="rgba(0,0,0,0.5)",o.fillRect(e,h,i,j)),b(".feedback-helper").each(function(){"blackout"==b(this).attr("data-type")&&(o.fillStyle="rgba(0,0,0,1)",o.fillRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height()))}),"click"==a.type&&a.pageX==rect.startX&&a.pageY==rect.startY&&(b("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+r+'" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+h+"px;left:"+e+"px;width:"+i+"px;height:"+j+'px;z-index:30000;"></div>'),p.push(r),++r,f(o))}}})}b(document).on("mouseleave","body,#feedback-canvas",function(){f(o)}),b(document).on("mouseenter",".feedback-helper",function(){f(o)}),b(document).on("click","#feedback-welcome-next",function(){b("#feedback-note").val().length>0?(c=!0,b("#feedback-canvas").css("cursor","crosshair"),b("#feedback-helpers").show(),b("#feedback-welcome").hide(),b("#feedback-highlighter").show()):b("#feedback-welcome-error").show()}),b(document).on("mouseenter mouseleave",".feedback-helper",function(a){drag||(rect.w=0,rect.h=0,"mouseenter"===a.type?(b(this).css("z-index","30001"),b(this).append('<div class="feedback-helper-inner" style="width:'+(b(this).width()-2)+"px;height:"+(b(this).height()-2)+'px;position:absolute;margin:1px;"></div>'),b(this).append('<div id="feedback-close"></div>'),b(this).find("#feedback-close").css({top:-1*(b(this).find("#feedback-close").height()/2)+"px",left:b(this).width()-b(this).find("#feedback-close").width()/2+"px"}),"blackout"==b(this).attr("data-type")&&(o.clearRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),o.fillStyle="rgba(102,102,102,0.5)",o.fillRect(0,0,b("#feedback-canvas").width(),b("#feedback-canvas").height()),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&g(o,parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),b(".feedback-helper").each(function(){"highlight"==b(this).attr("data-type")&&o.clearRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())}),o.clearRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height()),o.fillStyle="rgba(0,0,0,0.75)",o.fillRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height()),ignore=b(this).attr("data-time"),b(".feedback-helper").each(function(){return b(this).attr("data-time")==ignore?!0:void("blackout"==b(this).attr("data-type")&&(o.fillStyle="rgba(0,0,0,1)",o.fillRect(parseInt(b(this).css("left"),10),parseInt(b(this).css("top"),10),b(this).width(),b(this).height())))}))):(b(this).css("z-index","30000"),b(this).children().remove(),"blackout"==b(this).attr("data-type")&&f(o)))}),b(document).on("click","#feedback-close",function(){if(h.highlightElement&&b(this).parent().attr("data-highlight-id"))var a=b(this).parent().attr("data-highlight-id");b(this).parent().remove(),h.highlightElement&&a&&b('[data-highlight-id="'+a+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id"),f(o)}),b("#feedback-module").on("click",".feedback-wizard-close,.feedback-close-btn",function(){e()}),b(document).on("keyup",function(a){27==a.keyCode&&e()}),b(document).on("selectstart dragstart",document,function(a){a.preventDefault()}),b(document).on("click","#feedback-highlighter-back",function(){c=!1,b("#feedback-canvas").css("cursor","default"),b("#feedback-helpers").hide(),b("#feedback-highlighter").hide(),b("#feedback-welcome-error").hide(),b("#feedback-welcome").show()}),b(document).on("mousedown",".feedback-sethighlight",function(){highlight=1,b(this).addClass("feedback-active"),b(".feedback-setblackout").removeClass("feedback-active")}),b(document).on("mousedown",".feedback-setblackout",function(){highlight=0,b(this).addClass("feedback-active"),b(".feedback-sethighlight").removeClass("feedback-active")}),b(document).on("click","#feedback-highlighter-next",function(){c=!1,b("#feedback-canvas").css("cursor","default");var a=b(document).scrollTop(),d=b(window).height();b("#feedback-helpers").hide(),b("#feedback-highlighter").hide(),h.screenshotStroke||f(o,!1),k(b("body"),{onrendered:function(c){h.screenshotStroke||f(o),_canvas=b('<canvas id="feedback-canvas-tmp" width="'+m+'" height="'+d+'"/>').hide().appendTo("body"),_ctx=_canvas.get(0).getContext("2d"),_ctx.drawImage(c,0,a,m,d,0,0,m,d),i=_canvas.get(0).toDataURL(),b(document).scrollTop(a),post.img=i,h.onScreenshotTaken(post.img),h.showDescriptionModal?(b("#feedback-canvas-tmp").remove(),b("#feedback-overview").show(),b("#feedback-overview-description-text>textarea").remove(),b("#feedback-overview-screenshot>img").remove(),b('<textarea id="feedback-overview-note">'+b("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)"),b("#feedback-overview-screenshot").append('<img class="feedback-screenshot" src="'+i+'" />')):(b("#feedback-module").remove(),e(),_canvas.remove())},proxy:h.proxy,letterRendering:h.letterRendering})}),b(document).on("click","#feedback-overview-back",function(a){c=!0,b("#feedback-canvas").css("cursor","crosshair"),b("#feedback-overview").hide(),b("#feedback-helpers").show(),b("#feedback-highlighter").show(),b("#feedback-overview-error").hide()}),b(document).on("keyup","#feedback-note-tmp,#feedback-overview-note",function(a){var c;"feedback-note-tmp"===a.target.id?c=b("#feedback-note-tmp").val():(c=b("#feedback-overview-note").val(),b("#feedback-note-tmp").val(c)),b("#feedback-note").val(c)}),b(document).on("click","#feedback-submit",function(){c=!1,b("#feedback-note").val().length>0?(b("#feedback-submit-success,#feedback-submit-error").remove(),b("#feedback-overview").hide(),post.img=i,post.note=b("#feedback-note").val(),a.post(h.ajaxURL,post).then(function(){b("#feedback-module").append(h.tpl.submitSuccess)},function(){b("#feedback-module").append(h.tpl.submitError)})):b("#feedback-overview-error").show()})}))}}(jQuery),jQuery.feedback(b.options)}}}]);